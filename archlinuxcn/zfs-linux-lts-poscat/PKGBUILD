shopt -s extglob

pkgbase="zfs-linux-lts-poscat"
pkgname=("zfs-utils-poscat" "zfs-linux-lts-poscat" "zfs-linux-lts-poscat-headers")
_kernelver=6.6.65-1
_extramodules="${_kernelver}-lts"

pkgver=2.2.7
pkgrel=3
makedepends=(
  "linux-lts-headers=${_kernelver}"
  "libunwind"
)
arch=("x86_64")
url="https://openzfs.org/"
source=(
  "https://github.com/openzfs/zfs/releases/download/zfs-${pkgver}/zfs-${pkgver}.tar.gz"
  'zfs.initcpio.install'
  'zfs.initcpio.hook'
  'zfs.initcpio.zfsencryptssh.install'
  'fix-bash-completions.patch'
)
sha256sums=('b2b8e3bfabf2a6407a0132243726cb6762547a5bd095b1b1f37eaf2a9d8f7672'
            '2f09c742287f4738c7c09a9669f8055cd63d3b9474cd1f6d9447152d11a1b913'
            '15b5acea44225b4364ec6472a08d3d48666d241fe84c142e1171cd3b78a5584f'
            'ac9ed396465e26fa6896762c52a93eb7aaf8af6d7b2c69bd826d219ff821b2c9'
            'b9fa6a42f7426654fc04697b45ad1fe0fb09ff29ea76cb97ac7d09ac03de1797')
license=("CDDL-1.0")
depends=("kmod" "linux-lts=${_kernelver}")

prepare() {
  cd "${srcdir}/zfs-${pkgver}"
  patch -N -p0 -i "${srcdir}/fix-bash-completions.patch" || true
}

build() {
    cd "${srcdir}/zfs-${pkgver}"
    ./autogen.sh
    ./configure \
      --prefix=/usr \
      --sysconfdir=/etc \
      --sbindir=/usr/bin \
      --libdir=/usr/lib \
      --datadir=/usr/share \
      --localstatedir=/var \
      --includedir=/usr/include \
      --with-udevdir=/usr/lib/udev \
      --with-mounthelperdir=/usr/bin \
      --libexecdir=/usr/lib \
      --with-config=all \
      --with-linux=/usr/lib/modules/${_extramodules}/build \
      --with-linux-obj=/usr/lib/modules/${_extramodules}/build \
      --with-libunwind \
      --enable-pyzfs=no \
      --enable-systemd \
      --enable-sysvinit=no
    make
}

package_zfs-utils-poscat() {
    pkgdesc='ZFS userspace tools'
    provides=('zfs-utils' 'zfs-utils=2.2.7')
    conflicts=('zfs-utils')
    depends+=('libunwind')
    optdepends=('python: for arcstat/arc_summary/dbufstat')

    cd "${srcdir}/zfs-${pkgver}"
    make DESTDIR="${pkgdir}" install
    rm -rv "${pkgdir}"/lib
    rm -rv "${pkgdir}"/usr/src

    install -Dvm644 "${srcdir}"/zfs.initcpio.hook "${pkgdir}"/usr/lib/initcpio/hooks/zfs
    install -Dvm644 "${srcdir}"/zfs.initcpio.install "${pkgdir}"/usr/lib/initcpio/install/zfs
    install -Dvm644 "${srcdir}"/zfs.initcpio.zfsencryptssh.install "${pkgdir}"/usr/lib/initcpio/install/zfsencryptssh

    # cleanup
    ## empty files
    rm -rv "${pkgdir}"/etc/sudoers.d
    rm -rv "${pkgdir}"/usr/lib/modules-load.d
    ## debian/ubuntu specific
    rm -rv "${pkgdir}"/usr/share/initramfs-tools
    ## fedora specific
    rm -rv "${pkgdir}"/usr/lib/dracut
    ## test scripts
    rm -rv "${pkgdir}"/usr/share/zfs/{*.sh,runfiles,test-runner,zfs-tests}
}

package_zfs-linux-lts-poscat() {
    pkgdesc="ZFS kernel modules"
    install=zfs.install
    provides=("zfs" "spl")
    conflicts=("zfs-dkms" "zfs-dkms-git" "zfs-dkms-rc" "spl-dkms" "spl-dkms-git" 'zfs-linux-lts-git' 'zfs-linux-lts-rc' 'spl-linux-lts')
    replaces=("spl-linux-lts")
    depends+=("zfs-utils=${pkgver}")

    cd "${srcdir}/zfs-${pkgver}/module"
    make DESTDIR="${pkgdir}" INSTALL_MOD_PATH=${pkgdir}/usr INSTALL_MOD_STRIP=1 modules_install
}

package_zfs-linux-lts-poscat-headers() {
    pkgdesc="ZFS kernel headers"
    provides=("zfs-headers" "spl-headers")
    conflicts=("zfs-headers" "zfs-dkms" "zfs-dkms-git" "zfs-dkms-rc" "spl-dkms" "spl-dkms-git" "spl-headers")
    depends+=("libaio")

    cd "${srcdir}/zfs-${pkgver}"
    make DESTDIR="${pkgdir}" install
    rm -rv "${pkgdir}/lib"
    rm -rv "${pkgdir}/etc"
    rm -rv "${pkgdir}"/usr/!(src)
    # Remove reference to ${srcdir}
    sed -i "s+${srcdir}++" ${pkgdir}/usr/src/zfs-*/${_extramodules}/Module.symvers
}
